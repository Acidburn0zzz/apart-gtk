#!/usr/bin/env bash
# buildapi-variable-no-builddir

set -eu
PREFIX=/usr
while test $# -gt 0; do
  case "$1" in
    --prefix*)
      PREFIX=`echo $1 | sed -e 's/^[^=]*=//g'`
      echo "using prefix $PREFIX"
      shift
      ;;
  esac
done

failed=false

if command -v rustup >/dev/null 2>&1; then
  if [[ $(rustup toolchain list | grep -c stable) -eq 0 ]]; then
    rustup install stable
  fi
else
  echo >&2 "'rustup' required for build"
  failed=true
fi

if $failed; then exit 1; fi

sed "s|PREFIX = /usr|PREFIX = $PREFIX|" makefile.template > makefile
