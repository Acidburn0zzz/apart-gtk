#!/usr/bin/env bash

## requires python-pip & python-wheel unless --no-python-deps
set -eu
APART_CORE_VERSION="0.1.0"
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

pack_dependencies=true
for arg in "$@"; do
  if [ "$arg" == '--no-python-deps' ]; then
    pack_dependencies=false
    echo 'Skipping python dependency inclusion'
  fi
done

cd $DIR
rm -rf target
mkdir -p $DIR/target/lib/apart-gtk/src

echo Build apart-core
if [[ $(rustup toolchain list | grep -c stable) -eq 0 ]]; then
  rustup install stable
fi
cd $DIR/target
curl -o core.tar.gz -L https://github.com/alexheretic/apart-core/archive/v$APART_CORE_VERSION.tar.gz
echo '82fa2c04808c3f5e2caf1cf22b20797ba2d9510e2fa3f96cfabfdc0e3fee9f83 core.tar.gz' | sha256sum -c
tar xf core.tar.gz
(cd apart-core-$APART_CORE_VERSION && rustup run stable cargo build --release)
cp apart-core-$APART_CORE_VERSION/target/release/apart-core lib/apart-gtk/
rm core.tar.gz
rm -rf apart-core-$APART_CORE_VERSION

if $pack_dependencies ; then
  echo 'Pack dependiencies'
  cd $DIR/target/lib/apart-gtk/src
  pip wheel -r $DIR/dev-requirements.txt
  wheel unpack humanize-*.whl
  mv humanize-*/humanize ./
  rm -rf humanize-*

  pip wheel pyzmq
  wheel unpack pyzmq-*.whl
  mv pyzmq-*/zmq ./
  rm -rf pyzmq-*

  pip wheel PyYAML
  wheel unpack PyYAML-*.whl
  mv PyYAML-*/yaml ./
  rm -rf PyYAML-*
fi

echo 'Copy & compile sources'
cd $DIR/target/lib/apart-gtk/src
cp -r $DIR/src/* ./
python -m compileall ./


echo 'Copy misc & icons'
cd $DIR/target
mkdir -p share/applications
cp $DIR/misc/*.desktop share/applications/
mkdir -p share/icons/hicolor/scalable/apps/
cp $DIR/icon/apart.svg share/icons/hicolor/scalable/apps/
mkdir -p share/icons/hicolor/48x48/apps/
cp $DIR/icon/apart.png share/icons/hicolor/48x48/apps/
mkdir -p share/polkit-1/actions
cp $DIR/misc/*.policy share/polkit-1/actions/
mkdir -p bin
ln -s ../lib/apart-gtk/src/app.py bin/apart-gtk


tree -L 3 $DIR/target
